<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeria Google Drive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-4">Galeria z Google Drive</h1>
        <button id="authButton" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-4" onclick="handleAuthClick()">Zaloguj się do Google</button>
        <input type="file" id="fileInput" accept="image/jpeg,image/png,video/mp4,video/webm" class="mb-4 hidden" multiple>
        <button id="uploadButton" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mb-4 hidden" onclick="handleFileUpload()">Prześlij pliki</button>
        <div id="gallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </div>

    <script>
        // Konfiguracja Google API
        const CLIENT_ID = '423158260926-21qotkdtat68fh814ilqmqkc82rdo1m8.apps.googleusercontent.com'; // Wstaw swoje Client ID
        const API_KEY = 'AIzaSyDbs-HMHt__vQAjeSuU89U4WBhlr5EEnx4'; // Wstaw swój API Key
        const FOLDER_ID = '1XZnCvIUSJ0VQ13AlDJHp8VWSM_zZueTk'; // Wstaw ID folderu z Google Drive
        const SCOPES = 'https://www.googleapis.com/auth/drive';

        let gapiLoaded = false;
        let isSignedIn = false;

        // Ładowanie Google API
        function initGapi() {
            console.log('Inicjalizacja Google API...');
            gapi.load('client:auth2', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    scope: SCOPES,
                }).then(() => {
                    console.log('Google API zainicjalizowane pomyślnie');
                    gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                    updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                    gapiLoaded = true;
                }).catch((error) => {
                    console.error('Błąd inicjalizacji Google API:', error);
                    alert('Nie udało się zainicjalizować Google API. Sprawdź konsolę przeglądarki.');
                });
            });
        }

        // Aktualizacja statusu logowania
        function updateSigninStatus(signedIn) {
            console.log('Status logowania:', signedIn);
            isSignedIn = signedIn;
            const authButton = document.getElementById('authButton');
            const uploadButton = document.getElementById('uploadButton');
            const fileInput = document.getElementById('fileInput');

            if (isSignedIn) {
                console.log('Użytkownik zalogowany, ładuję pliki...');
                authButton.textContent = 'Wyloguj się';
                authButton.onclick = handleSignoutClick;
                uploadButton.classList.remove('hidden');
                fileInput.classList.remove('hidden');
                loadFiles();
            } else {
                console.log('Użytkownik wylogowany');
                authButton.textContent = 'Zaloguj się do Google';
                authButton.onclick = handleAuthClick;
                uploadButton.classList.add('hidden');
                fileInput.classList.add('hidden');
                document.getElementById('gallery').innerHTML = '';
            }
        }

        // Logowanie
        function handleAuthClick() {
            console.log('Próba logowania...');
            gapi.auth2.getAuthInstance().signIn();
        }

        // Wylogowanie
        function handleSignoutClick() {
            console.log('Wylogowywanie...');
            gapi.auth2.getAuthInstance().signOut();
        }

        // Pobieranie listy plików
        function loadFiles() {
            console.log('Pobieranie plików z folderu:', FOLDER_ID);
            gapi.client.drive.files.list({
                q: `'${FOLDER_ID}' in parents and (mimeType contains 'image/' or mimeType contains 'video/')`,
                fields: 'files(id, name, mimeType, thumbnailLink, webContentLink)',
            }).then((response) => {
                console.log('Odpowiedź API:', response.result.files);
                const files = response.result.files;
                const gallery = document.getElementById('gallery');
                gallery.innerHTML = '';

                if (files.length === 0) {
                    console.log('Brak plików w folderze');
                    gallery.innerHTML = '<p>Brak zdjęć lub filmów w folderze.</p>';
                }

                files.forEach((file) => {
                    const isVideo = file.mimeType.includes('video');
                    const element = document.createElement(isVideo ? 'video' : 'img');
                    element.className = 'w-full h-48 object-cover rounded';
                    element.src = isVideo ? file.webContentLink : file.thumbnailLink.replace('=s220', '=s800');
                    if (isVideo) {
                        element.controls = true;
                    }
                    const div = document.createElement('div');
                    div.className = 'relative';
                    div.appendChild(element);
                    gallery.appendChild(div);
                });
            }).catch((error) => {
                console.error('Błąd podczas pobierania plików:', error);
                alert('Błąd podczas ładowania plików. Sprawdź konsolę przeglądarki.');
            });
        }

        // Przesyłanie plików
        function handleFileUpload() {
            const files = document.getElementById('fileInput').files;
            if (!files.length) {
                alert('Wybierz co najmniej jeden plik!');
                return;
            }

            console.log('Przesyłanie', files.length, 'plików...');
            Array.from(files).forEach((file) => {
                const metadata = {
                    name: file.name,
                    parents: [FOLDER_ID],
                    mimeType: file.type,
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);

                fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token }),
                    body: form,
                }).then(() => {
                    console.log('Plik przesłany:', file.name);
                    loadFiles();
                    document.getElementById('fileInput').value = '';
                }).catch((error) => {
                    console.error('Błąd podczas przesyłania pliku:', error);
                    alert('Błąd podczas przesyłania pliku. Sprawdź konsolę przeglądarki.');
                });
            });
        }

        // Inicjalizacja po załadowaniu strony
        window.onload = initGapi;
    </script>
</body>
</html>