<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Galeria Miód Malina - Upload</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <button id="loginBtn">Zaloguj się z Google</button><br /><br />
  <input type="file" id="fileInput" multiple /><br /><br />
  <div id="status"></div>

<script>
const CLIENT_ID = '423158260926-21qotkdtat68fh814ilqmqkc82rdo1m8.apps.googleusercontent.com';
const FOLDER_ID = '1XZnCvIUSJ0VQ13AlDJHp8VWSM_zZueTk';
let accessToken = '';
let tokenClient;

function initializeTokenClient() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/drive.file',
    callback: (tokenResponse) => {
      accessToken = tokenResponse.access_token;
      document.getElementById('status').innerText = 'Zalogowano!';
    },
  });
}

function uploadFile(file) {
  if (!accessToken) {
    alert('Najpierw się zaloguj!');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const base64Data = e.target.result;

    fetch('https://script.google.com/macros/s/AKfycbxUIioa9U4rlyCgD3CcRtROQC2cmv4rLegxvIULzg74ISKRfdBK-bKif0HHa2A45tQc/exec?action=upload&folderId=' + FOLDER_ID, {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: new URLSearchParams({
        filename: file.name,
        mimeType: file.type,
        contents: base64Data
      })
    })
    .then(res => res.json())
    .then(data => {
      if(data.success) {
        document.getElementById('status').innerText = `Plik ${file.name} przesłany!`;
      } else {
        alert('Błąd uploadu: ' + data.error);
      }
    })
    .catch(() => alert('Błąd uploadu'));
  };
  reader.readAsDataURL(file);
}

window.onload = () => {
  initializeTokenClient();

  document.getElementById('loginBtn').onclick = () => {
    tokenClient.requestAccessToken();
  };

  document.getElementById('fileInput').addEventListener('change', (e) => {
    if (!accessToken) {
      alert('Zaloguj się najpierw');
      return;
    }
    for (const file of e.target.files) {
      uploadFile(file);
    }
  });
};
</script>

</body>
</html>
