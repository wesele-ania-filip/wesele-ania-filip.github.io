<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Galeria Google Drive</title>
  <!-- Bootstrap CSS for responsive gallery layout -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      background-color: #f8f9fa;
    }
    .gallery-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .gallery-item {
      transition: transform 0.2s;
    }
    .gallery-item:hover {
      transform: scale(1.05);
    }
    .btn-container {
      margin-bottom: 20px;
    }
    #errorMsg {
      display: none;
      color: red;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4">Galeria Google Drive</h1>
    
    <!-- Login/Logout Buttons -->
    <div class="btn-container text-center">
      <button id="loginBtn" class="btn btn-primary me-2" onclick="handleAuthClick()">Zaloguj się</button>
      <button id="logoutBtn" class="btn btn-secondary" onclick="handleSignoutClick()" style="display: none;">Wyloguj</button>
      <button id="uploadBtn" class="btn btn-success" onclick="uploadFile()" style="display: none;">Wgraj plik</button>
    </div>

    <!-- Error Message -->
    <p id="errorMsg"></p>

    <!-- Gallery Display -->
    <div id="gallery" class="row"></div>
  </div>

  <!-- Google API and Bootstrap JS -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Google Drive API credentials (replace with your actual values)
    const API_KEY = 'AIzaSyDbs-HMHt__vQAjeSuU89U4WBhlr5EEnx4'; // Replace with your Google API key
    const FOLDER_ID = '1XZnCvIUSJ0VQ13AlDJHp8VWSM_zZueTk'; // Replace with your Google Drive folder ID
    const CLIENT_ID = '423158260926-21qotkdtat68fh814ilqmqkc82rdo1m8.apps.googleusercontent.com'; // Replace with your OAuth 2.0 Client ID
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    // Global flag to track API initialization
    let isApiInitialized = false;

    // Load Google API client
    function initClient() {
      if (!gapi) {
        showError('Błąd: Biblioteka Google API nie załadowana.');
        return;
      }
      gapi.load('client:auth2', () => {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(() => {
          isApiInitialized = true;
          // Check login status
          const authInstance = gapi.auth2.getAuthInstance();
          authInstance.isSignedIn.listen(updateSigninStatus);
          updateSigninStatus(authInstance.isSignedIn.get());
          // Load gallery without requiring login
          loadGallery();
        }).catch(error => {
          console.error('Error initializing Google API client:', error);
          showError('Błąd inicjalizacji API Google. Sprawdź klucze API i ustawienia.');
        });
      });
    }

    // Show error message
    function showError(message) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.textContent = message;
      errorMsg.style.display = 'block';
    }

    // Update UI based on login status
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'inline-block';
        document.getElementById('uploadBtn').style.display = 'inline-block';
      } else {
        document.getElementById('loginBtn').style.display = 'inline-block';
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('uploadBtn').style.display = 'none';
      }
    }

    // Handle login
    function handleAuthClick() {
      if (!isApiInitialized || !gapi.auth2.getAuthInstance()) {
        showError('API Google nie jest gotowe. Spróbuj ponownie za chwilę.');
        return;
      }
      gapi.auth2.getAuthInstance().signIn().catch(error => {
        console.error('Login error:', error);
        showError('Błąd podczas logowania. Sprawdź połączenie lub ustawienia API.');
      });
    }

    // Handle logout
    function handleSignoutClick() {
      if (!isApiInitialized || !gapi.auth2.getAuthInstance()) {
        showError('API Google nie jest gotowe.');
        return;
      }
      gapi.auth2.getAuthInstance().signOut();
    }

    // Load gallery images from Google Drive (public access with API key)
    function loadGallery() {
      if (!isApiInitialized) {
        showError('API Google nie jest gotowe. Spróbuj ponownie za chwilę.');
        return;
      }
      gapi.client.drive.files.list({
        q: `'${FOLDER_ID}' in parents and mimeType contains 'image/'`,
        fields: 'files(id, name, thumbnailLink, webViewLink)',
        key: API_KEY
      }).then(response => {
        const files = response.result.files;
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = ''; // Clear existing content
        if (files && files.length > 0) {
          files.forEach(file => {
            // Create gallery item with thumbnail
            const col = document.createElement('div');
            col.className = 'col-md-4 col-sm-6 mb-4 gallery-item';
            const img = document.createElement('img');
            // Use thumbnailLink or fallback to webViewLink
            img.src = file.thumbnailLink ? file.thumbnailLink.replace(/=s\d+/, '=s220') : file.webViewLink;
            img.alt = file.name;
            img.className = 'gallery-img';
            img.onerror = () => { img.src = 'https://via.placeholder.com/220?text=Brak+miniatury'; }; // Fallback image
            img.onclick = () => window.open(file.webViewLink, '_blank');
            col.appendChild(img);
            gallery.appendChild(col);
          });
        } else {
          gallery.innerHTML = '<p class="text-center">Brak zdjęć w galerii.</p>';
        }
      }).catch(error => {
        console.error('Error loading gallery:', error);
        showError('Błąd podczas ładowania galerii. Sprawdź ID folderu lub uprawnienia.');
      });
    }

    // File upload (only for logged-in users)
    function uploadFile() {
      if (!isApiInitialized || !gapi.auth2.getAuthInstance().isSignedIn.get()) {
        showError('Zaloguj się, aby wgrać plik.');
        return;
      }
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = () => {
        const file = input.files[0];
        if (file) {
          const formData = new FormData();
          formData.append('file', file);
          const metadata = {
            name: file.name,
            mimeType: file.type,
            parents: [FOLDER_ID]
          };
          gapi.client.request({
            path: '/upload/drive/v3/files',
            method: 'POST',
            params: { uploadType: 'multipart' },
            headers: {
              'Content-Type': 'multipart/related; boundary="foo_bar_baz"'
            },
            body: `--foo_bar_baz
Content-Type: application/json; charset=UTF-8

${JSON.stringify(metadata)}

--foo_bar_baz
Content-Type: ${file.type}

${file}

--foo_bar_baz--`
          }).then(() => {
            alert('Plik wgrany pomyślnie!');
            loadGallery(); // Refresh gallery
          }).catch(error => {
            console.error('Error uploading file:', error);
            showError('Błąd podczas wgrywania pliku.');
          });
        }
      };
      input.click();
    }

    // Initialize the client on page load
    window.onload = () => {
      if (typeof gapi === 'undefined') {
        showError('Błąd: Biblioteka Google API nie załadowana. Sprawdź połączenie z internetem.');
        return;
      }
      initClient();
    };
  </script>
</body>
</html>